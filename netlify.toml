# Netlify configuration for Next.js 15 deployment

[build]
command = "npm run build"
functions = "netlify/functions"
publish = ".next"

[build.environment]
# Node version
NODE_VERSION = "20"
# Enable Next.js optimizations
NEXT_TELEMETRY_DISABLED = "1"

# Enable ISR (Incremental Static Regeneration)
[[headers]]
for = "/api/*"
[headers.values]
Cache-Control = "public, s-maxage=0, stale-while-revalidate=3600"

# Set longer timeout for AI endpoints (up to 26s on paid plan, 10s free)
[functions]
node_bundler = "esbuild"

# Environment variables for Edge Functions (optional, for faster AI routes)
[functions."api/ai/*"]
node_bundler = "esbuild"
timeout = 26

# Global security headers
[[headers]]
for = "/*"
[headers.values]
	# Enforce modern security defaults
	X-Frame-Options = "DENY"
	X-Content-Type-Options = "nosniff"
	Referrer-Policy = "strict-origin-when-cross-origin"
	Permissions-Policy = "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=(), interest-cohort=()"
	Cross-Origin-Opener-Policy = "same-origin"
	Cross-Origin-Resource-Policy = "same-site"
	# HSTS (only effective over HTTPS). Adjust max-age and preload as needed.
	Strict-Transport-Security = "max-age=63072000; includeSubDomains; preload"

# Optional: CSP in Report-Only to validate before enforcing
[[headers]]
for = "/*"
[headers.values]
	Content-Security-Policy-Report-Only = "default-src 'self'; script-src 'self' 'unsafe-eval' 'wasm-unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; font-src 'self' https: data:; connect-src 'self' https: wss:; frame-ancestors 'none'; base-uri 'self'; form-action 'self'"
